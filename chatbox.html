<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAINTHALCYON Pixel Chatbox</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-color: #ffd1e5;
    --container-bg: #fff5fb;
    --border-color: #6b6b6b;
    --accent-pink: #ff8fab;
    --text-color: #4a4a4a;
    --chat-bg: #fffdf7;
  }

  body {
    background: var(--bg-color);
    font-family: 'Press Start 2P', monospace;
    margin: 0;
    font-size: 10px;
    color: var(--text-color);
    display: flex;
    justify-content: center;
    min-height: 100vh;
    padding-top: 20px;
  }

  #page {
    width: 1000px;
    max-width: 95vw;
    background: var(--container-bg);
    border: 4px solid var(--border-color);
    box-shadow: 8px 8px 0px rgba(0,0,0,0.1);
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* Banner Placeholder - CSS Pattern instead of missing GIF */
  #banner {
    width: 100%;
    height: 120px;
    border: 3px double var(--border-color);
    background: repeating-linear-gradient(
      45deg,
      #ffbcd9,
      #ffbcd9 10px,
      #ffe3ef 10px,
      #ffe3ef 20px
    );
    display: flex;
    align-items: center;
    justify-content: center;
    text-shadow: 2px 2px #fff;
    color: #ff5c8d;
    font-size: 16px;
  }

  #main-interface {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }

  /* Chat Section */
  #chat-section {
    flex: 2;
    display: flex;
    flex-direction: column;
    min-width: 300px;
  }

  #chat-messages {
    flex: 1;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border: 3px double var(--border-color);
    background: var(--chat-bg);
    scrollbar-width: thin;
    scrollbar-color: var(--accent-pink) var(--chat-bg);
  }

  #chat-messages::-webkit-scrollbar { width: 8px; }
  #chat-messages::-webkit-scrollbar-track { background: var(--chat-bg); }
  #chat-messages::-webkit-scrollbar-thumb { background-color: var(--accent-pink); border: 1px solid var(--border-color); }

  .message {
    border-bottom: 1px dotted var(--border-color);
    margin-bottom: 8px;
    padding-bottom: 8px;
    line-height: 1.5;
    word-break: break-word;
  }

  .message-username {
    color: #ff5c8d;
    font-size: 9px;
    margin-bottom: 4px;
    display: block;
  }

  .message img {
    width: 100px; /* Resize sent drawings */
    height: 100px;
    image-rendering: pixelated;
    border: 1px solid var(--border-color);
    background: #fff;
  }

  .message-time {
    font-size: 7px;
    color: #999;
    margin-top: 4px;
    display: block;
    text-align: right;
  }

  /* Drawing Section */
  #draw-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 250px;
  }

  #canvas-wrapper {
    position: relative;
    border: 3px double var(--border-color);
    width: 220px;
    height: 220px;
    background: #fff; /* Checkerboard pattern for transparency */
    background-image:
      linear-gradient(45deg, #eee 25%, transparent 25%),
      linear-gradient(-45deg, #eee 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, #eee 75%),
      linear-gradient(-45deg, transparent 75%, #eee 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    cursor: crosshair;
  }

  /* The Magic: Small internal resolution, scaled up display */
  #draw-canvas {
    width: 100%;
    height: 100%;
    image-rendering: pixelated; /* Critical for pixel art look */
  }

  #controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: #fff;
    padding: 8px;
    border: 2px solid var(--border-color);
  }

  #color-palette { display: flex; gap: 6px; flex-wrap: wrap; }
  
  .color-swatch {
    width: 24px;
    height: 24px;
    border: 2px solid #ccc;
    cursor: pointer;
    position: relative;
  }
  
  .color-swatch.active { border-color: #000; transform: scale(1.1); }

  .tools-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 8px;
  }

  input[type="range"] { accent-color: var(--accent-pink); cursor: pointer; }

  #sticker-container {
    display: flex;
    gap: 5px;
    justify-content: center;
    margin-top: 5px;
    border-top: 1px dotted #ccc;
    padding-top: 5px;
  }

  .sticker {
    width: 32px;
    height: 32px;
    cursor: pointer;
    image-rendering: pixelated;
    transition: transform 0.1s;
  }
  .sticker:hover { transform: translateY(-2px); }

  /* Input Area */
  #chat-input-area {
    display: flex;
    gap: 6px;
    padding-top: 10px;
    border-top: 3px solid var(--border-color);
  }

  input {
    padding: 8px;
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    border: 2px solid var(--border-color);
    background: #fff;
    color: #333;
  }

  #username { width: 100px; flex-shrink: 0; }
  #message { flex: 1; }

  button {
    padding: 8px 10px;
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    cursor: pointer;
    background: #ffe3ef;
    border: 2px solid var(--border-color);
    color: var(--text-color);
    box-shadow: 2px 2px 0px var(--border-color);
    transition: all 0.1s;
  }

  button:active {
    transform: translate(2px, 2px);
    box-shadow: none;
  }

  button.primary { background: #ff8fab; color: white; }

</style>
</head>

<body>

<div id="page">
  <div id="banner">
    SAINTHALCYON
  </div>

  <div id="main-interface">
    <!-- Chat Column -->
    <div id="chat-section">
      <div id="chat-messages">
        <!-- Messages appear here -->
        <div class="message">
          <span class="message-username">System</span>
          Welcome to SAINTHALCYON! Draw and chat.
          <span class="message-time">Now</span>
        </div>
      </div>
    </div>

    <!-- Drawing Column -->
    <div id="draw-section">
      <div id="canvas-wrapper">
        <!-- Internal resolution is 55x55, styled to 220x220 -->
        <canvas id="draw-canvas" width="55" height="55"></canvas>
      </div>

      <div id="controls">
        <div id="color-palette">
          <!-- Generated by JS -->
        </div>
        
        <div class="tools-row">
          <label>
            Pen: <span id="pen-size-display">1</span>px
            <input type="range" id="pen-size" min="1" max="5" value="1">
          </label>
          <button id="clear-btn">CLR</button>
        </div>

        <div id="sticker-container">
          <!-- Base64 Pixel Art Stickers -->
          <img class="sticker" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5gQWES425Y6w3wAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAOElEQVRYw+3WMQoAIAwDwO7+/zU0E6aA4S04Q5M9O6p7s27s27s27s27s27s27s27s27s27s27s27s2T4AcL4B9U4B4T4AAAAASUVORK5CYII=" title="Heart">
          <img class="sticker" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5gQWES425Y6w3wAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAdklEQVRYw+3WsQqAMAwEwU9F+/6sQ0Mq4OaM0D2mZ8D7J3+4d38O2T7pN2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdp92g3+gf8g9O4B9Q0B4j0AAAAASUVORK5CYII=" title="Star">
          <img class="sticker" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5gQWES425Y6w3wAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAUklEQVRYw+3WMQoAIAwDwO7+/zWw02mM0D6d0D2VZ8PpN3+4d38O2T7pN2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt2m3aTdpt92h3+A/8Q9e4A9Q4B4z0AAAAASUVORK5CYII=" title="Smile">
        </div>
      </div>
    </div>
  </div>

  <div id="chat-input-area">
    <input type="text" id="username" placeholder="User" maxlength="12">
    <input type="text" id="message" placeholder="Type here..." maxlength="100">
    <button id="send-button" class="primary">SEND</button>
    <button id="send-draw-button">ART</button>
  </div>
</div>

<script>
/**
 * CHAT SYSTEM
 * Uses LocalStorage to simulate a database so it works instantly for you.
 * You can replace the `db` object methods with Firebase calls if desired.
 */
class LocalChat {
  constructor() {
    this.storageKey = 'sainthalcyon_chat';
    this.messages = JSON.parse(localStorage.getItem(this.storageKey) || '[]');
    this.listeners = [];
  }

  // Simulate pushing to DB
  push(data) {
    const record = {
      id: Date.now(),
      timestamp: new Date().toISOString(),
      ...data
    };
    this.messages.push(record);
    if (this.messages.length > 50) this.messages.shift(); // Keep only last 50
    this.save();
    this.notify(record);
  }

  save() {
    localStorage.setItem(this.storageKey, JSON.stringify(this.messages));
  }

  // Simulate Firebase 'child_added'
  onChildAdded(callback) {
    // Send existing messages
    this.messages.forEach(msg => callback(msg));
    // Listen for new ones
    this.listeners.push(callback);
  }

  notify(record) {
    this.listeners.forEach(cb => cb(record));
  }
}

const db = new LocalChat();

// UI Elements
const chatMessages = document.getElementById("chat-messages");
const usernameInput = document.getElementById("username");
const messageInput = document.getElementById("message");
const sendButton = document.getElementById("send-button");
const sendDrawButton = document.getElementById("send-draw-button");

// Send Message
function sendMessage() {
  const username = usernameInput.value.trim() || "Anon";
  const message = messageInput.value.trim();
  if(!message) return;
  
  db.push({ username, message });
  messageInput.value = "";
  messageInput.focus();
}

// Send Drawing
function sendDrawing() {
  const username = usernameInput.value.trim() || "Anon";
  // Get image from canvas
  const imgData = canvas.toDataURL("image/png");
  
  db.push({ 
    username, 
    message: `<img src="${imgData}" />`, 
    type: 'art' 
  });
}

// Listen for messages
db.onChildAdded(data => {
  const time = new Date(data.timestamp);
  const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  const msgEl = document.createElement("div");
  msgEl.className = "message";
  // If it's a system message or text, handle text content safely
  const contentHtml = (data.type === 'art') ? data.message : escapeHtml(data.message);

  msgEl.innerHTML = `
    <span class="message-username">${escapeHtml(data.username)}</span>
    <div class="message-text">${contentHtml}</div>
    <span class="message-time">${timeStr}</span>
  `;
  
  chatMessages.appendChild(msgEl);
  chatMessages.scrollTop = chatMessages.scrollHeight;
});

// Simple HTML escape to prevent XSS
function escapeHtml(text) {
  if (!text) return "";
  return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
}

sendButton.addEventListener("click", sendMessage);
messageInput.addEventListener("keypress", (e) => { if(e.key === 'Enter') sendMessage(); });
sendDrawButton.addEventListener("click", sendDrawing);


/**
 * PIXEL DRAWING SYSTEM
 * Uses a low-res canvas scaled up for true pixel art feel.
 */
const canvas = document.getElementById("draw-canvas");
const ctx = canvas.getContext("2d", { alpha: true });

// Set white background initially
ctx.fillStyle = "#ffffff";
ctx.fillRect(0, 0, canvas.width, canvas.height);

// State
let isDrawing = false;
let currentColor = "#ff8fab";
let currentSize = 1;

// Palette Setup
const colors = [
  "#ff8fab", "#ffc6ff", "#bdb2ff", "#caffbf", "#ffd6a5", 
  "#ff6961", "#ffca3a", "#8ac926", "#1982c4", "#6a4c93",
  "#ffffff", "#000000"
];

const paletteContainer = document.getElementById("color-palette");
colors.forEach((c, index) => {
  const sw = document.createElement("div");
  sw.className = "color-swatch";
  sw.style.background = c;
  if(index === 0) sw.classList.add('active'); // Set default active
  
  sw.addEventListener("click", () => {
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
    sw.classList.add('active');
    currentColor = c;
  });
  paletteContainer.appendChild(sw);
});

// Pen Size
const sizeInput = document.getElementById("pen-size");
const sizeDisplay = document.getElementById("pen-size-display");
sizeInput.addEventListener("input", (e) => {
  currentSize = parseInt(e.target.value);
  sizeDisplay.innerText = currentSize;
});

// Clear Button
document.getElementById("clear-btn").addEventListener("click", () => {
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
});

// Drawing Logic
// Since CSS scales the canvas, we need to map mouse coordinates to the internal 55x55 grid
function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  
  let x = (e.clientX - rect.left) * scaleX;
  let y = (e.clientY - rect.top) * scaleY;
  
  // Snap to grid based on pen size
  // If pen size is 1, snap to 1. If 2, snap to 2s, etc.
  x = Math.floor(x / currentSize) * currentSize;
  y = Math.floor(y / currentSize) * currentSize;
  
  return { x, y };
}

function draw(e) {
  if (!isDrawing) return;
  const { x, y } = getPos(e);
  
  ctx.fillStyle = currentColor;
  // Draw a rectangle relative to the 55x55 grid
  ctx.fillRect(x, y, currentSize, currentSize);
}

canvas.addEventListener("mousedown", (e) => {
  isDrawing = true;
  draw(e);
});
window.addEventListener("mouseup", () => { isDrawing = false; });
canvas.addEventListener("mousemove", draw);

// Sticker Logic
document.querySelectorAll(".sticker").forEach(st => {
  st.addEventListener("click", () => {
    const img = new Image();
    img.src = st.src;
    img.onload = () => {
      // Place sticker randomly, but snapped to 5px grid (approx)
      const snap = 5;
      const x = Math.floor(Math.random() * (canvas.width - 10) / snap) * snap;
      const y = Math.floor(Math.random() * (canvas.height - 10) / snap) * snap;
      
      // Draw image slightly larger to be visible on 55x55 grid
      ctx.drawImage(img, x, y, 10, 10); 
    };
  });
});

</script>
</body>
</html>
