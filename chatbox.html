<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAINTHALCYON'S LOUNGE</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  background: #ffd1e5;
  font-family: 'Press Start 2P', monospace;
  font-size: 10px;
  display: flex;
  justify-content: center;
  padding: 20px;
}

#page {
  width: 900px;
  background: #fff5fb;
  border: 4px solid #6b6b6b;
  padding: 10px;
}

#chat-messages {
  height: 350px;
  overflow-y: auto;
  border: 3px double #6b6b6b;
  padding: 10px;
  background: #fff;
}

.message {
  border-bottom: 1px dotted #aaa;
  padding-bottom: 6px;
  margin-bottom: 6px;
}

.message-username {
  color: #ff5c8d;
  font-size: 9px;
  display: block;
}

.message-time {
  font-size: 7px;
  text-align: right;
  color: #999;
}

.message img {
  width: 100px;
  height: 100px;
  image-rendering: pixelated;
  border: 1px solid #6b6b6b;
}

#canvas-wrapper {
  margin-top: 10px;
  width: 220px;
  height: 220px;
  border: 3px double #6b6b6b;
}

canvas {
  width: 100%;
  height: 100%;
  image-rendering: pixelated;
}

#chat-input {
  display: flex;
  gap: 6px;
  margin-top: 10px;
}

input, button {
  font-family: 'Press Start 2P', monospace;
  font-size: 9px;
  padding: 6px;
}
</style>
</head>

<body>

<div id="page">

  <div id="chat-messages">
    <div id="loading">loadingâ€¦</div>
  </div>

  <div id="canvas-wrapper">
    <canvas id="draw" width="55" height="55"></canvas>
  </div>

  <div id="chat-input">
    <input id="username" placeholder="User" maxlength="20">
    <input id="message" placeholder="Message" maxlength="100">
    <button id="send">SEND</button>
    <button id="send-art">ART</button>
  </div>

</div>

<script>
/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyB8eG54hE9HNmiEhx7ON7JKWpqc3a4R7ns",
  authDomain: "sainthalcyon-87144.firebaseapp.com",
  databaseURL: "https://sainthalcyon-87144-default-rtdb.firebaseio.com",
  projectId: "sainthalcyon-87144",
  storageBucket: "sainthalcyon-87144.appspot.com",
  messagingSenderId: "257264228367",
  appId: "1:257264228367:web:313ffc00542858c0152b7a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const chatRef = db.ref("chat");

/* ================= UI ================= */

const chatBox = document.getElementById("chat-messages");
const userInput = document.getElementById("username");
const msgInput = document.getElementById("message");

/* ================= HELPERS ================= */

function escapeHtml(text) {
  return text.replace(/[&<>]/g, c =>
    ({ "&":"&amp;", "<":"&lt;", ">":"&gt;" }[c])
  );
}

function addMessage(data) {
  const el = document.createElement("div");
  el.className = "message";

  let content = "";
  if (data.type === "art") {
    content = `<img src="${data.image}">`;
  } else {
    content = escapeHtml(data.message);
  }

  const time = new Date(data.timestamp || Date.now())
    .toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

  el.innerHTML = `
    <span class="message-username">${escapeHtml(data.username)}</span>
    <div>${content}</div>
    <span class="message-time">${time}</span>
  `;

  chatBox.appendChild(el);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* ================= SEND ================= */

document.getElementById("send").onclick = () => {
  const msg = msgInput.value.trim();
  if (!msg) return;

  chatRef.push({
    username: userInput.value || "Anon",
    message: msg,
    type: "text",
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });

  msgInput.value = "";
};

document.getElementById("send-art").onclick = () => {
  const img = canvas.toDataURL("image/png");

  chatRef.push({
    username: userInput.value || "Anon",
    image: img,
    type: "art",
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });
};

/* ================= LISTENER ================= */

chatRef.limitToLast(50).on("child_added", snap => {
  document.getElementById("loading")?.remove();
  addMessage(snap.val());
});

/* ================= CANVAS ================= */

const canvas = document.getElementById("draw");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;
ctx.fillStyle = "#fff";
ctx.fillRect(0,0,55,55);

let drawing = false;

canvas.onmousedown = e => {
  drawing = true;
  draw(e);
};

window.onmouseup = () => drawing = false;

canvas.onmousemove = e => {
  if (drawing) draw(e);
};

function draw(e) {
  const r = canvas.getBoundingClientRect();
  const x = Math.floor((e.clientX - r.left) * 55 / r.width);
  const y = Math.floor((e.clientY - r.top) * 55 / r.height);
  ctx.fillStyle = "#ff5c8d";
  ctx.fillRect(x,y,1,1);
}
</script>

</body>
</html>
