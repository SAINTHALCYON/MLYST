<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAINTHALCYON'S LOUNGE</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root {
    --bg-color: #ffd1e5;
    --container-bg: #fff5fb;
    --border-color: #6b6b6b;
    --accent-pink: #ff8fab;
    --text-color: #4a4a4a;
    --chat-bg: #fffdf7;
  }

  body {
    background-color: var(--bg-color); 
    background-image: url('https://i.pinimg.com/originals/db/e3/da/dbe3da5acbd6544e87d13d8b1e2b7fc8.gif'); 
    background-size: cover;
    background-attachment: fixed;
    
    font-family: 'Press Start 2P', monospace;
    margin: 0;
    font-size: 10px;
    color: var(--text-color);
    display: flex;
    justify-content: center;
    min-height: 100vh;
    padding-top: 20px;
  }

  #page {
    width: 1000px;
    max-width: 95vw;
    background: var(--container-bg);
    border: 4px solid var(--border-color);
    border-image: url("DIVIDER3.png") 10 round;
    box-shadow: 8px 8px 0px rgba(0,0,0,0.1);
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #banner {
    width: 100%;
    height: 120px;
    border: 3px double var(--border-color);
    border-image: url("dividercake.png") 10 round;
    
    background-color: #ffbcd9; 
    background-image: url('https://i.pinimg.com/736x/a7/04/51/a704518ada1747ef747b3ac293923bf0.jpg');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    
    display: flex;
    align-items: center;
    justify-content: center;
    text-shadow: 2px 2px #fff;
    color: #ff5c8d;
    font-size: 16px;
  }

  #main-interface {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }

  #chat-section {
    flex: 2;
    display: flex;
    flex-direction: column;
    min-width: 300px;
  }

  #chat-messages {
    flex: 1;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border: 3px double var(--border-color);
    border-image: url("dividercake.png") 10 round;
    background: var(--chat-bg);
    scrollbar-width: thin;
    scrollbar-color: var(--accent-pink) var(--chat-bg);
  }

  .message {
    border-bottom: 1px dotted var(--border-color);
    border-image: url("dividercake.png") 10 round; 
    margin-bottom: 8px;
    padding-bottom: 8px;
    line-height: 1.5;
    word-break: break-word;
  }

  .message-username {
    color: #ff5c8d;
    font-size: 9px;
    margin-bottom: 4px;
    display: block;
  }

  .message img {
    width: 100px;
    height: 100px;
    image-rendering: pixelated;
    border: 1px solid var(--border-color);
    background: #fff;
  }

  .message-time {
    font-size: 7px;
    color: #999;
    margin-top: 4px;
    display: block;
    text-align: right;
  }

  #draw-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 250px;
  }

  #canvas-wrapper {
    position: relative;
    border: 3px double var(--border-color);
    border-image: url("dividercake.png") 10 round;
    width: 220px;
    height: 220px;
    background: #fff;
    background-image:
      linear-gradient(45deg, #eee 25%, transparent 25%),
      linear-gradient(-45deg, #eee 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, #eee 75%),
      linear-gradient(-45deg, transparent 75%, #eee 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    cursor: crosshair;
  }

  #draw-canvas {
    width: 100%;
    height: 100%;
    image-rendering: pixelated;
  }

  #controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: #fff;
    padding: 8px;
    border: 2px solid var(--border-color);
    border-image: url("dividercake.png") 10 round;
  }

  #color-palette { display: flex; gap: 6px; flex-wrap: wrap; }
  
  .color-swatch {
    width: 24px;
    height: 24px;
    border: 2px solid #ccc;
    border-image: url("dividercake.png") 10 round;
    cursor: pointer;
    position: relative;
  }
  
  .color-swatch.active { border-color: #000; transform: scale(1.1); }

  .tools-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 8px;
  }

  input[type="range"] { accent-color: var(--accent-pink); cursor: pointer; }

  #sticker-container {
    display: flex;
    gap: 5px;
    justify-content: center;
    margin-top: 5px;
    border-top: 1px dotted #ccc;
    padding-top: 5px;
  }

  .sticker {
    width: 32px;
    height: 32px;
    cursor: pointer;
    image-rendering: pixelated;
    transition: transform 0.1s;
  }
  .sticker:hover { transform: translateY(-2px); }

  #chat-input-area {
    display: flex;
    gap: 6px;
    padding-top: 10px;
    border-top: 3px solid var(--border-color);
  }

  input {
    padding: 8px;
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    border: 2px solid var(--border-color);
    border-image: url("dividercake.png") 10 round;
    background: #fff;
    color: #333;
  }

  #username { width: 100px; flex-shrink: 0; }
  #message { flex: 1; }

  button {
    padding: 8px 10px;
    font-family: 'Press Start 2P', monospace;
    font-size: 9px;
    cursor: pointer;
    background: #ffe3ef;
    border: 2px solid var(--border-color);
    border-image: url("dividercake.png") 10 round;
    color: var(--text-color);
    box-shadow: 2px 2px 0px var(--border-color);
    transition: all 0.1s;
  }

  button:active {
    transform: translate(2px, 2px);
    box-shadow: none;
  }

  button.primary { background: #ff8fab; color: white; }

</style>
</head>

<body>

<div id="page">
  <div id="banner">
  </div>

  <div id="main-interface">
    <div id="chat-section">
      <div id="chat-messages">
        <div class="message" id="loading-msg">
          <span class="message-username">update log:</span>
          connecting to server...
          <span class="message-time">Now</span>
        </div>
      </div>
    </div>
    
    <div id="draw-section">
      <div id="canvas-wrapper">
        <canvas id="draw-canvas" width="55" height="55"></canvas>
      </div>

      <div id="controls">
        <div id="color-palette">
  
        </div>
        
        <div class="tools-row">
          <label>
            Pen: <span id="pen-size-display">1</span>px
            <input type="range" id="pen-size" min="1" max="5" value="1">
          </label>
          <button id="clear-btn">CLR</button>
        </div>

        <div id="sticker-container">
          <img class="sticker" src="https://i.pinimg.com/originals/18/ba/5d/18ba5d426eae90d75234a5df205081a8.gif" title="hey">
          <img class="sticker" src="https://i.pinimg.com/originals/3f/5b/cb/3f5bcb6cb126f029823af8a5fce4e54c.gif" title="there">
          <img class="sticker" src="https://i.pinimg.com/originals/7d/84/ab/7d84abb3988424b344939b3d1c60d684.gif" title="faggot!">
        </div>
      </div>
    </div>
  </div>

  <div id="chat-input-area">
    <input type="text" id="username" placeholder="User" maxlength="20">
    <input type="text" id="message" placeholder="Type here..." maxlength="100">
    <button id="send-button" class="primary">SEND</button>
    <button id="send-draw-button">ART</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCzN3J1PO77sunfc4TSdO7kq7SxRwK4pPA",
  authDomain: "sainthalcyon-23fd5.firebaseapp.com",
  projectId: "sainthalcyon-23fd5",
  storageBucket: "sainthalcyon-23fd5.firebasestorage.app",
  messagingSenderId: "907348360352",
  appId: "1:907348360352:web:9fc9b04e225ba07b751dc5",
  measurementId: "G-NLF0GCMD2H",
  databaseURL: "https://sainthalcyon-23fd5-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

let db = null;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  console.log("Firebase initialized successfully.");
} catch(e) {
  console.error("Firebase Init Error:", e);
  const loading = document.getElementById("loading-msg");
  if(loading) loading.innerHTML = "Error: Check Console";
}

// UI Elements
const chatMessages = document.getElementById("chat-messages");
const usernameInput = document.getElementById("username");
const messageInput = document.getElementById("message");
const sendButton = document.getElementById("send-button");
const sendDrawButton = document.getElementById("send-draw-button");

function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

function addMessageToUI(data) {
  try {
    const timeStr = data.timestamp ? new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "??";
    const contentHtml = (data.type === 'art') ? data.message : escapeHtml(data.message);
    
    const msgEl = document.createElement("div");
    msgEl.className = "message";
    msgEl.innerHTML = `
      <span class="message-username">${escapeHtml(data.username)}</span>
      <div class="message-text">${contentHtml}</div>
      <span class="message-time">${timeStr}</span>
    `;
    
    chatMessages.appendChild(msgEl);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  } catch (uiError) {
    console.error("Error adding message to UI:", uiError);
  }
}

function sendMessage() {
  if (!db) return alert("Chat is offline.");
  const username = usernameInput.value.trim() || "Anon";
  const message = messageInput.value.trim();
  if(!message) return;
  
  const chatRef = db.ref("chat");
  
  chatRef.push({
    username, message, type: 'text',
    timestamp: firebase.database.ServerValue.TIMESTAMP
  }, (error) => {
    if (error) {
      alert("Send Failed: " + error.message);
      console.error("Firebase write error:", error);
    } else {
      messageInput.value = "";
    }
  });
}

function sendDrawing() {
  if (!db) return alert("Chat is offline.");
  const username = usernameInput.value.trim() || "Anon";
  const imgData = canvas.toDataURL("image/png");
  
  const chatRef = db.ref("chat");
  
  chatRef.push({
    username,
    message: `<img src="${imgData}" />`,
    type: 'art',
    timestamp: firebase.database.ServerValue.TIMESTAMP
  }, (error) => {
    if (error) {
      alert("Art Failed: " + error.message);
    }
  });
}

sendButton.addEventListener("click", sendMessage);
messageInput.addEventListener("keypress", (e) => { if(e.key === 'Enter') sendMessage(); });
sendDrawButton.addEventListener("click", sendDrawing);

if (db) {
  db.ref("chat").limitToLast(50).on("child_added", snapshot => {
    const data = snapshot.val();
    const loading = document.getElementById("loading-msg");
    if(loading) loading.remove();
    addMessageToUI(data);
  }, (error) => {
    console.error("Listener Error:", error);
    alert("Connection Error: " + error.message);
  });
}

const canvas = document.getElementById("draw-canvas");
const ctx = canvas.getContext("2d", { alpha: true });

ctx.imageSmoothingEnabled = false; 
ctx.fillStyle = "#ffffff";
ctx.fillRect(0, 0, canvas.width, canvas.height);

let isDrawing = false;
let currentColor = "#ff8fab";
let currentSize = 1;
let lastX = 0;
let lastY = 0;

const colors = [
  "#ff8fab", "#ffc6ff", "#bdb2ff", "#caffbf", "#ffd6a5", 
  "#ff6961", "#ffca3a", "#8ac926", "#1982c4", "#6a4c93",
  "#ffffff", "#000000"
];

const paletteContainer = document.getElementById("color-palette");
colors.forEach((c, index) => {
  const sw = document.createElement("div");
  sw.className = "color-swatch";
  sw.style.background = c;
  if(index === 0) sw.classList.add('active'); 
  
  sw.addEventListener("click", () => {
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
    sw.classList.add('active');
    currentColor = c;
  });
  paletteContainer.appendChild(sw);
});

const sizeInput = document.getElementById("pen-size");
const sizeDisplay = document.getElementById("pen-size-display");
sizeInput.addEventListener("input", (e) => {
  currentSize = parseInt(e.target.value);
  sizeDisplay.innerText = currentSize;
});

document.getElementById("clear-btn").addEventListener("click", () => {
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
});

function drawPixel(x, y) {
  ctx.fillStyle = currentColor;
  ctx.fillRect(x, y, currentSize, currentSize);
}

function drawLine(x0, y0, x1, y1) {
  const dx = Math.abs(x1 - x0);
  const dy = Math.abs(y1 - y0);
  const sx = (x0 < x1) ? 1 : -1;
  const sy = (y0 < y1) ? 1 : -1;
  let err = dx - dy;

  while(true) {
    drawPixel(x0, y0);
    if ((x0 === x1) && (y0 === y1)) break;
    const e2 = 2 * err;
    if (e2 > -dy) { err -= dy; x0 += sx; }
    if (e2 < dx) { err += dx; y0 += sy; }
  }
}

function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  
  let x = (e.clientX - rect.left) * scaleX;
  let y = (e.clientY - rect.top) * scaleY;
  
  x = Math.floor(x / currentSize) * currentSize;
  y = Math.floor(y / currentSize) * currentSize;
  
  return { x, y };
}

canvas.addEventListener("mousedown", (e) => {
  isDrawing = true;
  const pos = getPos(e);
  lastX = pos.x;
  lastY = pos.y;
  drawPixel(lastX, lastY);
});

window.addEventListener("mouseup", () => { isDrawing = false; });

canvas.addEventListener("mousemove", (e) => {
  if (!isDrawing) return;
  const pos = getPos(e);
  drawLine(lastX, lastY, pos.x, pos.y);
  lastX = pos.x;
  lastY = pos.y;
});

document.querySelectorAll(".sticker").forEach(st => {
  st.addEventListener("click", () => {
    const img = new Image();
    img.src = st.src;
    img.onload = () => {
      const snap = 5;
      const x = Math.floor(Math.random() * (canvas.width - 10) / snap) * snap;
      const y = Math.floor(Math.random() * (canvas.height - 10) / snap) * snap;
      ctx.drawImage(img, x, y, 10, 10); 
    };
  });
});
</script>
</body>
</html>
